cache:
  key: wordpuzzle-cache
  paths:
    - public
    - .stack
    - .stack-work

build:
  image:
    name: haskell:8.4.4
    entrypoint: [""]
  stage: build
  variables:
    RTSOPTS: "+RTS -N1"
    STACK_ROOT: "${CI_PROJECT_DIR}/.stack"
  script:
    - stack setup
    - stack build --pedantic --no-test --ghc-options='-O2'
    - stack test --coverage
    - stack haddock
    - stack bench --benchmark-arguments '-o .stack-work/benchmark.html'
    - rm -rf public
    - cp -pr doc/ public/
    - cp -p .stack-work/benchmark.html public/
    - cp -pr $(find .stack-work/install -type d -name hpc) public/
    - cp -pr $(find .stack-work/dist -type d -name html) public/
  artifacts:
    paths:
      - .stack-work/install/x86_64-linux/lts-12.26/8.4.4/bin/wordpuzzle

pages:
  image: maven:3.6.0-jdk-8-slim
  stage: deploy
  script:
    - echo Publishing pages ...
  artifacts:
    paths:
      - public
  only:
    - master
