---
stages:
  - build
  - deploy

build:
  stage: build
  image:
    name: frankhjung/haskell:${GHC_VERSION}
  variables:
    APP_VERSION: 1.0.0
    CABAL_CONFIG: ${CABAL_DIR}/config
    CABAL_DIR: ${CI_PROJECT_DIR}/.cabal
    DOC_DIR: dist-newstyle/build/x86_64-linux/ghc-${GHC_VERSION}/${PROJECT}-${APP_VERSION}/x/${PROJECT}/doc/html/${PROJECT}/${PROJECT}
    GHC_VERSION: 9.6.7
    PROJECT: wordpuzzle
  script:
    - make setup
    - make check
    - make build
    - make doc
    - mv ${DOC_DIR} public
    - make test
    - make bench
    - EXE_PATH=$(find dist-newstyle -name wordpuzzle -type f -executable | head -n 1)
    - cp "$EXE_PATH" release/wordpuzzle
    - cp dictionary release/dictionary
  artifacts:
    paths:
      - public
      - release
  before_script:
    - mkdir -p release
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - ${CABAL_DIR}

pages:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
  image: alpine:latest
  script:
    - echo Publish pages ...
  dependencies:
    - build
  artifacts:
    paths:
      - public

package_and_release:
  stage: deploy
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v/
  needs:
    - job: build
      artifacts: true
  script:
    - apk add --no-cache curl tar ca-certificates glab
    - echo "Packaging release for ${CI_COMMIT_TAG}"
    - tar -czf wordpuzzle-release.tar.gz -C release wordpuzzle dictionary
    - |
      curl --header "JOB-TOKEN: $CI_JOB_TOKEN" --upload-file wordpuzzle-release.tar.gz \
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/wordpuzzle/${CI_COMMIT_TAG}/wordpuzzle-release.tar.gz"
    - |
      RELEASE_URL="${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/wordpuzzle/${CI_COMMIT_TAG}/wordpuzzle-release.tar.gz"
      RELEASE_DESC="Autogenerated release for version ${CI_COMMIT_TAG}"
      if glab release create ${CI_COMMIT_TAG} \
        --name "Release ${CI_COMMIT_TAG}" \
        --description "${RELEASE_DESC}" \
        --update \
        --repo-owner "${CI_PROJECT_NAMESPACE}" \
        --repo-name "${CI_PROJECT_NAME}" 2>/dev/null; then
        echo "Release created/updated successfully with glab"
      else
        echo "Creating release via GitLab API..."
        curl --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "tag_name=${CI_COMMIT_TAG}" \
          --form "name=Release ${CI_COMMIT_TAG}" \
          --form "description=${RELEASE_DESC}" \
          --form "milestones[]=wordpuzzle" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases" || \
        curl --request PUT \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "name=Release ${CI_COMMIT_TAG}" \
          --form "description=${RELEASE_DESC}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases/${CI_COMMIT_TAG}"
      fi

run-wordpuzzle:
  stage: deploy
  image: ubuntu:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"
  variables:
    SIZE: "4"
    LETTERS: ""
    REPEATS: "true"
    TARGET_TAG: "" # Set this when triggering pipeline manually
  script:
    - apt-get update && apt-get install -y curl tar ca-certificates
    - |
      if [ -z "${TARGET_TAG}" ]; then
        echo "ERROR: TARGET_TAG not set. Please provide the release tag to run."
        exit 1
      fi
    - echo "Running wordpuzzle for release ${TARGET_TAG}"
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --location \
      "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/wordpuzzle/${TARGET_TAG}/wordpuzzle-release.tar.gz" \
      --output wordpuzzle-release.tar.gz
    - tar -xzf wordpuzzle-release.tar.gz
    - chmod +x wordpuzzle
    - |
      SIZE_INT="${SIZE%%[^0-9]*}"
      LETTERS_LOWER="${LETTERS,,}"
      ARGS="--size=$SIZE_INT --letters=${LETTERS_LOWER} --dictionary=dictionary"
      if [ "${REPEATS}" = "true" ]; then ARGS="${ARGS} --repeats"; fi
      echo "Running wordpuzzle with args: ${ARGS}"
      ./wordpuzzle ${ARGS}
